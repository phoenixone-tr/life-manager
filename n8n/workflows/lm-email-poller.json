{
  "name": "LM - Email Poller",
  "nodes": [
    {
      "parameters": {},
      "id": "trigger-business",
      "name": "ğŸ“§ Business Email Trigger",
      "type": "n8n-nodes-base.microsoftOutlookTrigger",
      "typeVersion": 1,
      "position": [200, 200],
      "credentials": {
        "microsoftOutlookOAuth2Api": {
          "id": "REPLACE_WITH_BUSINESS_CREDENTIAL_ID",
          "name": "M365 Business Email"
        }
      }
    },
    {
      "parameters": {},
      "id": "trigger-family",
      "name": "ğŸ“§ Family Email Trigger",
      "type": "n8n-nodes-base.microsoftOutlookTrigger",
      "typeVersion": 1,
      "position": [200, 500],
      "credentials": {
        "microsoftOutlookOAuth2Api": {
          "id": "REPLACE_WITH_FAMILY_CREDENTIAL_ID",
          "name": "M365 Family Email"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "account-tag",
              "name": "account",
              "value": "business",
              "type": "string"
            }
          ]
        }
      },
      "id": "set-account-business",
      "name": "ğŸ¢ Set Account: Business",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [460, 200]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "account-tag",
              "name": "account",
              "value": "family",
              "type": "string"
            }
          ]
        }
      },
      "id": "set-account-family",
      "name": "ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Set Account: Family",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [460, 500]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://10.10.10.211:8000/api/v1/email/classify",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ from_address: $json.from?.emailAddress?.address || $json.sender?.emailAddress?.address || '', from_name: $json.from?.emailAddress?.name || $json.sender?.emailAddress?.name || '', subject: $json.subject || '', body_preview: $json.bodyPreview || '', received_at: $json.receivedDateTime || '', has_attachments: $json.hasAttachments || false, importance: ($json.importance || 'normal').toLowerCase(), account: $json.account || 'business', message_id: $json.id || '' }) }}",
        "options": {
          "timeout": 10000
        }
      },
      "id": "classify-email",
      "name": "ğŸ¤– Classify Email",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [720, 350]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "check-notify",
              "leftValue": "={{ $json.actions }}",
              "rightValue": "notify_telegram",
              "operator": {
                "type": "array",
                "operation": "contains"
              }
            }
          ],
          "combinator": "and"
        }
      },
      "id": "filter-notify",
      "name": "ğŸ” Should Notify?",
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2,
      "position": [960, 350]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "telegram-msg",
              "name": "telegram_message",
              "value": "={{ (() => {\n  const priorityEmoji = { high: 'ğŸ”´', medium: 'ğŸŸ¡', low: 'âšª' };\n  const categoryLabels = {\n    server_alert: 'Server Alert',\n    invoice: 'Rechnung',\n    client_inquiry: 'Kundenanfrage',\n    newsletter: 'Newsletter',\n    personal: 'PersÃ¶nlich',\n    spam_suspect: 'Spam-Verdacht',\n    uncategorized: 'Unkategorisiert'\n  };\n  const e = $json.email || {};\n  const accountLabel = (e.account || 'business') === 'business' ? 'Business' : 'Family';\n  const emoji = priorityEmoji[$json.priority] || 'âšª';\n  const category = categoryLabels[$json.category] || $json.category;\n  const fromName = e.from_name || '';\n  const fromAddr = e.from_address || '';\n  const subject = e.subject || '';\n  const preview = e.body_preview || '';\n  const previewShort = preview.length > 200 ? preview.substring(0, 200) + '...' : preview;\n  const fromLine = fromName ? fromName + ' (' + fromAddr + ')' : fromAddr;\n  const lines = [];\n  lines.push('ğŸ“§ Neue Email (' + accountLabel + ')');\n  lines.push('Von: ' + fromLine);\n  lines.push('Betreff: ' + subject);\n  lines.push('Kategorie: ' + emoji + ' ' + category + ' (' + $json.priority + ')');\n  lines.push('---');\n  lines.push(previewShort);\n  return lines.join('\\n');\n})() }}",
              "type": "string"
            }
          ]
        }
      },
      "id": "format-telegram",
      "name": "ğŸ“ Format Telegram Message",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [1200, 350]
    },
    {
      "parameters": {
        "chatId": "REPLACE_WITH_MARTIN_CHAT_ID",
        "text": "={{ $json.telegram_message }}",
        "additionalFields": {}
      },
      "id": "send-telegram",
      "name": "ğŸ“± Send Telegram",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [1440, 350],
      "credentials": {
        "telegramApi": {
          "id": "REPLACE_WITH_TELEGRAM_CREDENTIAL_ID",
          "name": "Life Manager Bot"
        }
      }
    }
  ],
  "connections": {
    "ğŸ“§ Business Email Trigger": {
      "main": [
        [
          {
            "node": "ğŸ¢ Set Account: Business",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“§ Family Email Trigger": {
      "main": [
        [
          {
            "node": "ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Set Account: Family",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ¢ Set Account: Business": {
      "main": [
        [
          {
            "node": "ğŸ¤– Classify Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Set Account: Family": {
      "main": [
        [
          {
            "node": "ğŸ¤– Classify Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ¤– Classify Email": {
      "main": [
        [
          {
            "node": "ğŸ” Should Notify?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ” Should Notify?": {
      "main": [
        [
          {
            "node": "ğŸ“ Format Telegram Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“ Format Telegram Message": {
      "main": [
        [
          {
            "node": "ğŸ“± Send Telegram",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [
    {
      "name": "life-manager"
    }
  ]
}
